<?xml version="1.0" encoding="utf-8" ?>
<!-- 
    2
	As DOCTYPE either 
	the strict XHTML declaration or 
	"-//HbbTV//1.1.1//EN" "http://www.hbbtv.org/dtd/HbbTV-1.1.1.dtd"
	shall be used as described in the HbbTV-standard: A.2.6.2.
-->
<!DOCTYPE html PUBLIC "-//HbbTV//1.1.1//EN" "http://www.hbbtv.org/dtd/HbbTV-1.1.1.dtd">
<!-- Required XML-namespace as described in the HbbTV-standard: A.2.6.2. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" test="1">

<head>
    <meta http-equiv="content-type" content="application/vnd.hbbtv.xhtml+xml; charset=UTF-8" />
    <title>Dive SDK</title>
    <style>
        html,
        body,
        .diveContainer,
        #root {
            width: 100%;
            height: 100%;
            position: relative;
            padding: 0;
            margin: 0;
        }
    </style>
    <!--
	<script type="text/javascript" src="http://192.168.17.47:8082/console.io.js?url=http://192.168.17.47:8082"></script>
    <script>
        if (document.cookie.indexOf("serialNumber") == -1) {
            document.cookie = "serialNumber=" + Math.floor((Math.random() * 10000) + 1);
        }
    </script>
    -->
</head>

<body onload="initApp()" style="background-color: grey">
    <!-- ApplicationManager extracts information out of the AIT (such as lifecycle, autostart, etc.) -->
    <div id="oipf-objects" style="position: absolute; left: 0px; top: 0px; width: 0px; height: 0px;">
        <object type="application/oipfApplicationManager" id="oipfAppMan" style="position: absolute; left: 0px; top: 0px; width: 0px; height: 0px;"></object>
        <object type="application/oipfConfiguration" id="oipfConfig" style="position: absolute; left: 0px; top: 0px; width: 0px; height: 0px;"></object>
    </div>
    <div id="root"></div>
    <script crossorigin="anonymous"  type="text/javascript">
        function init() {
            /*function fetchData() {
                var URL = 'https://api.github.com';
                var xhr = new XMLHttpRequest();
                //xhr.setRequestHeader("origin", window.location.protocol + "//" + window.location.host);
                xhr.onreadystatechange = function () {
                    document.body.innerHTML = JSON.stringify(xhr);
                }
                xhr.open('GET', URL)
                xhr.send()
            }
            fetchData();*/
            try {
                DiveSDK.front.init({ selector: "#root", apiKey: "dG91Y2h2aWVfYXBpOkYyUUhMZThYdEd2R1hRam50V3FMVXFjdGI5QmRVdDRT", deviceId: "test" });
                console.log("APP REALLY INITIALIZED");
            } catch(e) {
                console.error("Error initializing app", e);
            }
        }
    </script>
    <script crossorigin="anonymous" type="text/javascript">
        function setKeyset(mask) {
            var elemcfg, app;
            // for HbbTV 0.5:
            // try {
            //     elemcfg = document.getElementById('oipfcfg');
            //     elemcfg.keyset.value = mask;
            // } catch (e) {
            //     // ignore
            //     console.error("error keys", e);
            // }
            // try {
            //     elemcfg = document.getElementById('oipfcfg');
            //     elemcfg.keyset.setValue(mask);
            // } catch (e) {
            //     // ignore
            //     console.error("error keys", e);
            // }
            // for HbbTV 1.0:
            try {
                app = document.getElementById('oipfAppMan').getOwnerApplication(document);
                app.privateData.keyset.setValue(mask);
                console.log("KEYS OK FOR HBBTV 1.0");
            } catch (e) {
                // ignore
                console.error("error keys", e);
            }
        }
        function initApp() {
            setTimeout(function () {
                console.log("HBBTV TIMEOUT TRIGGERED");
                try {
                    console.log("LOADING HBBTV");
                    document.getElementById("oipfAppMan").getOwnerApplication(document).show();
                    console.log("LOADED HBBTV");
                    setKeyset(0x1 + 0x2 + 0x4 + 0x8 + 0x10);
                    console.log("KEYS SETUP");
                    init();
                    console.log("APP INITIALIZED");
                } catch (e) {
                    console.log("ERROR HBBTV", e);
                    var el = document.getElementById("body");
                    var msg = e.toString().substr(20);
                }
                try {
                    var loadJS = function (url, implementationCode, location) {
                        //url is URL of external file, implementationCode is the code
                        //to be called from the file, location is the location to 
                        //insert the <script> element
                        console.log("CREATING SCRIPT");
                        var scriptTag = document.createElement('script');
                        console.log("CREATED SCRIPT");
                        scriptTag.src = url;
                        console.log("CREATED SCRIPT 2");
                        scriptTag.type = "text/javascript";
                        console.log("CREATED SCRIPT 3");
                        scriptTag.onload = implementationCode;
                        console.log("CREATED SCRIPT 4");
                        //scriptTag.onreadystatechange = implementationCode;
                        console.log("VOY A APENDAR", url);
                        location.appendChild(scriptTag);
                        console.log("APPENDED", url);
                    };
                    var yourCodeToBeCalled = function () {
                        //your code goes here
                        console.log("LOADED");
                    }
                    var loadOtherScripts = function (a) {
                        //your code goes here
                        console.log("LOADED", a);
                        console.log("LOADING2");
                        setTimeout(function () {
                            loadJS('/DiveSDK.main.js', yourCodeToBeCalled, document.body);
                            console.log("LOADING3");
                            //loadJS('/DiveSDK.styles.js', yourCodeToBeCalled, document.body);
                        }, 1000);
                    }
                    console.log("LOADING");
                    //loadJS('/vendor.bundle.js', loadOtherScripts, document.body);
                }
                catch (e) {
                    console.error("ERRROR LOADIIIING", e);
                }
            }, 2000);
        }
    </script>
</body>

</html>